<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Heart</title>
<meta name="theme-color" content="#0b0d12" />
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link rel="preconnect" href="https://fonts.googleapis.com">
<style>
  :root{
    --fg:#e5e7eb; --muted:#a3adc2; --card:#ffffffdd;
    --accent:#ef4444; --accent2:#fecaca; --accent3:#f472b6;
    --bg1:#0b0d12; --bg2:#0e1320;
    --title-font: ui-rounded, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    --body-font:  ui-rounded, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    --ring:#fff;
  }

  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; font-family:var(--body-font); color:var(--fg);
    background:var(--bg1); overflow:hidden;
    -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
  }

  .bg{
    position:fixed; inset:0; z-index:-4;
    background:
      radial-gradient(1100px 700px at 15% 20%, color-mix(in oklab, var(--accent) 45%, transparent), transparent 60%),
      radial-gradient(1000px 700px at 85% 30%, color-mix(in oklab, var(--accent2) 45%, transparent), transparent 60%),
      radial-gradient(900px 700px at 40% 90%, color-mix(in oklab, var(--accent3) 35%, transparent), transparent 60%),
      linear-gradient(120deg, var(--bg1), var(--bg2) 50%, var(--bg1));
    animation:bgDrift 20s ease-in-out infinite alternate;
    filter:saturate(1.05) brightness(1.03);
    will-change: transform;
  }
  @keyframes bgDrift{from{transform:translateX(0)} to{transform:translateX(-1.6%)}}
  @media (prefers-reduced-motion: reduce){ .bg{ animation:none } }

  #stars{position:fixed; inset:0; pointer-events:none; z-index:-3; display:block}

  .wrap{height:100%;display:grid;place-items:center;padding:22px;text-align:center}
  .title{
    margin:0; font-size:clamp(40px,10vw,86px); line-height:1.02;
    background:linear-gradient(90deg,#fff,color-mix(in srgb,var(--accent2) 35%,#fff));
    -webkit-background-clip:text;background-clip:text;color:transparent;
    filter:drop-shadow(0 8px 24px color-mix(in srgb, var(--accent) 22%, transparent));
    font-weight:900; letter-spacing:.5px;
  }
  .cta{
    margin-top:16px; display:inline-flex; align-items:center; gap:10px;
    padding:12px 16px; border-radius:14px; border:0; cursor:pointer;
    background:linear-gradient(90deg,var(--accent),var(--accent3));
    color:#0a0b0f; font-weight:900; box-shadow:0 10px 28px rgba(0,0,0,.25);
    transition:transform .12s ease, box-shadow .12s ease, opacity .2s ease;
  }
  .cta.secondary{ background:linear-gradient(90deg,#f9fafb,#e5e7eb); }
  .cta:hover{ transform:translateY(-1px); box-shadow:0 16px 34px rgba(0,0,0,.33) }
  .cta:active{ transform:translateY(0) }
  .cta:focus-visible{ outline:3px solid var(--ring); outline-offset:3px }

  nav.nav{position:fixed;left:18px;top:18px;display:flex;gap:10px;flex-wrap:wrap}
  .pill{
    display:inline-block;padding:8px 12px;border-radius:999px;
    background:var(--card);color:#0a0b0f;font-weight:800;
    text-decoration:none; transition:transform .12s ease, box-shadow .12s ease, opacity .2s ease;
    box-shadow:0 6px 16px rgba(0,0,0,.16)
  }
  .pill:focus-visible{outline:2px solid #fff; outline-offset:2px}
  .pill:hover{transform:translateY(-1px); box-shadow:0 10px 22px rgba(0,0,0,.22)}
  .pill:active{transform:translateY(0)}

  .xpWrap{
    position:fixed; right:18px; top:18px; display:flex; align-items:center; gap:12px;
    max-width:min(520px, 70vw);
  }
  .xp-badge{
    background:var(--card);color:#0a0b0f;border-radius:12px;padding:6px 10px;
    font-size:13px;font-weight:800;box-shadow:0 8px 18px rgba(0,0,0,.15)
  }
  .xp-bar{
    flex:1;height:10px;border-radius:999px;background:rgba(255,255,255,.22);
    overflow:hidden;position:relative;box-shadow:inset 0 2px 6px rgba(0,0,0,.25)
  }
  .xp-fill{
    position:absolute;left:0;top:0;bottom:0;width:0%;
    background:linear-gradient(90deg,var(--accent),var(--accent2));
    box-shadow:0 6px 20px rgba(13,148,255,.35);transition:width .45s ease
  }
  .xp-meta{position:fixed;right:18px;top:52px;font-size:12px;color:#cbd5e1;opacity:.9}

  .hint{ font-size:12px; opacity:.8 }

  /* Studio (draw) */
  dialog{ border:none; padding:0; background:transparent; }
  dialog#studio, dialog#poems { width:min(1200px, 96vw); max-height:92vh; }
  .frame{
    display:grid; grid-template-rows:auto 1fr auto;
    background:#0c1120; border-radius:20px; box-shadow:0 30px 80px rgba(0,0,0,.45);
    overflow:hidden; border:1px solid rgba(255,255,255,.08)
  }
  .top{
    display:flex; align-items:center; justify-content:space-between; gap:10px;
    padding:12px 14px; background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
  }
  .title-sub{font-weight:900; letter-spacing:.3px}
  .close-btn{
    appearance:none; border:0; background:var(--card); color:#0a0b0f; font-weight:900;
    padding:6px 10px; border-radius:10px; cursor:pointer;
  }

  .toolbar{
    display:flex; flex-wrap:wrap; gap:10px; align-items:center;
    padding:12px 14px; border-top:1px solid rgba(255,255,255,.06); border-bottom:1px solid rgba(255,255,255,.06);
    background:rgba(255,255,255,.02);
  }
  .tool{
    appearance:none; border:0; padding:8px 10px; border-radius:12px; cursor:pointer;
    background:rgba(255,255,255,.12); color:#fff; font-weight:800;
  }
  .tool[aria-pressed="true"]{ outline:2px solid #fff; outline-offset:2px; background:rgba(255,255,255,.22) }
  .color-swatch{
    width:28px;height:28px;border-radius:999px;border:2px solid rgba(255,255,255,.65);
    display:inline-block; cursor:pointer;
  }
  .grow{ flex:1 }
  .tool-group{ display:flex; gap:10px; align-items:center }
  .slider{ width:150px }

  .canvas-wrap{
    position:relative; background:#0a0f1a; display:grid; place-items:center;
    min-height:40vh; height:min(60vh, 60dvh); padding:14px;
  }
  canvas#draw{
    background:#0b0f18; border-radius:12px; box-shadow:inset 0 0 0 1px rgba(255,255,255,.08);
    touch-action:none; width:100%; height:100%; display:block; max-width:100%; max-height:100%;
  }

  .bottom{
    display:flex; gap:10px; align-items:center; justify-content:flex-end;
    padding:12px 14px; background:linear-gradient(0deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
  }
  .btn{
    appearance:none; border:0; padding:10px 14px; border-radius:14px; cursor:pointer; font-weight:900;
    background:var(--card); color:#0a0b0f;
  }
  .btn.danger{ background:#fecaca; color:#7f1d1d }
  .btn.primary{ background:linear-gradient(90deg,var(--accent),var(--accent3)); color:#0a0b0f }
  .btn:focus-visible{ outline:3px solid var(--ring); outline-offset:3px }

  /* Poems UI */
  .poems-main{ display:grid; gap:14px; padding:14px }
  .split{ display:grid; gap:12px; grid-template-columns:repeat(auto-fit, minmax(220px, 1fr)); align-items:start }
  .card{
    background:rgba(255,255,255,.06);
    border:1px solid rgba(255,255,255,.08);
    border-radius:16px; padding:14px;
  }
  .input, .textarea{
    width:100%; padding:10px 12px; border-radius:12px; border:1px solid rgba(255,255,255,.14);
    background:rgba(255,255,255,.06); color:#fff; font:inherit;
  }
  .textarea{ min-height:180px; resize:vertical }
  .list{ display:grid; gap:8px; max-height:min(48vh, 48dvh); overflow:auto; padding-right:4px }
  .list-item{
    display:flex; justify-content:space-between; align-items:center; gap:10px;
    background:rgba(255,255,255,.04); border:1px solid rgba(255,255,255,.1);
    border-radius:12px; padding:10px 12px; cursor:pointer;
  }
  .list-item:hover{ background:rgba(255,255,255,.07) }

  .poem-view{ display:grid; gap:12px }
  .poem-title{ font-weight:900 }
  .poem-text{ white-space:pre-wrap; line-height:1.5; }
  .actions{ display:flex; gap:8px; flex-wrap:wrap }
  .muted{ opacity:.8; font-size:12px }

  .sr-only{ position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0 }
</style>
</head>
<body>
  <div class="bg" aria-hidden="true"></div>
  <canvas id="stars" aria-hidden="true"></canvas>

  <nav class="nav" aria-label="Site">
    <a class="pill" href="index.html" title="Go to Home">‚Üê Home</a>
    <a class="pill" href="body.html" title="Go to Body">Body</a>
    <a class="pill" href="mind.html" title="Go to Mind">Mind</a>
    <a class="pill" href="soul.html" title="Go to Soul">Soul</a>
  </nav>

  <div class="xpWrap" role="status" aria-live="polite">
    <div class="xp-badge" id="xpBadge" aria-label="Level badge">Level 0</div>
    <div class="xp-bar" aria-label="Experience progress">
      <div class="xp-fill" id="xpFill"></div>
    </div>
  </div>
  <div class="xp-meta" id="xpMeta">0 / 200 XP</div>

  <div class="wrap" role="main">
    <h1 class="title">Heart</h1>

    <div style="display:flex; gap:12px; flex-wrap:wrap; justify-content:center">
      <button id="openStudio" class="cta" type="button" title="Open drawing panel">‚ù§Ô∏è Pour your heart out</button>
      <button id="openPoems" class="cta secondary" type="button" title="Open poems hub">üìù Poems</button>
    </div>

    <p class="hint" style="margin-top:10px;opacity:.75">
      Draw/write from the heart, or craft/read poems. Save, share, or keep for later.
    </p>
  </div>

  <!-- Drawing / Writing Studio -->
  <dialog id="studio">
    <div class="frame" role="dialog" aria-labelledby="studioTitle">
      <div class="top">
        <div class="title-sub" id="studioTitle">Pour your heart out</div>
        <button class="close-btn" id="closeStudio" type="button" title="Close">Close</button>
      </div>

      <div class="toolbar" aria-label="Tools">
        <div class="tool-group" role="group" aria-label="Mode">
          <button id="penTool" class="tool" aria-pressed="true" title="Pen">Pen</button>
          <button id="eraserTool" class="tool" aria-pressed="false" title="Eraser">Eraser</button>
        </div>

        <div class="tool-group" role="group" aria-label="Color">
          <span class="color-swatch" data-color="#ffffff" style="background:#ffffff"></span>
          <span class="color-swatch" data-color="#ef4444" style="background:#ef4444"></span>
          <span class="color-swatch" data-color="#22c55e" style="background:#22c55e"></span>
          <span class="color-swatch" data-color="#3b82f6" style="background:#3b82f6"></span>
          <span class="color-swatch" data-color="#f59e0b" style="background:#f59e0b"></span>
          <label class="tool" style="display:inline-flex;align-items:center;gap:8px">
            <span style="opacity:.85">Pick</span>
            <input id="colorPicker" type="color" value="#ffffff" style="width:28px;height:28px;border:0;background:transparent;padding:0">
          </label>
        </div>

        <div class="tool-group" role="group" aria-label="Brush size">
          <label class="tool" for="size">Size</label>
          <input id="size" class="slider" type="range" min="1" max="48" value="8">
        </div>

        <div class="grow"></div>

        <div class="tool-group" role="group" aria-label="History">
          <button id="undoBtn" class="tool" title="Undo">Undo</button>
          <button id="redoBtn" class="tool" title="Redo">Redo</button>
        </div>
      </div>

      <div class="canvas-wrap" id="canvasHost">
        <canvas id="draw" width="1280" height="720" aria-label="Drawing canvas"></canvas>
      </div>

      <div class="bottom">
        <span class="hint" style="margin-right:auto">Tip: Use a stylus on touch devices for smoother handwriting.</span>
        <button id="deleteBtn" class="btn danger" type="button" title="Clear drawing">Delete</button>
        <button id="saveBtn" class="btn" type="button" title="Save PNG">Save</button>
        <button id="shareBtn" class="btn primary" type="button" title="Share">Share</button>
      </div>
    </div>
  </dialog>

  <!-- Poems Hub -->
  <dialog id="poems">
    <div class="frame" role="dialog" aria-labelledby="poemsTitle">
      <div class="top">
        <div class="title-sub" id="poemsTitle">Poems</div>
        <button class="close-btn" id="closePoems" type="button" title="Close">Close</button>
      </div>

      <div class="poems-main">
        <div class="split">
          <!-- Left: Actions -->
          <div class="card">
            <div style="display:flex; gap:8px; flex-wrap:wrap">
              <button id="poemWriteTab" class="btn primary" type="button">Write a poem</button>
              <button id="poemReadTab" class="btn" type="button">Read a poem</button>
            </div>
          </div>

          <!-- Right: Context / Tips -->
          <div class="card">
            <div style="font-weight:800; margin-bottom:6px">Public-domain selection</div>
            <div class="muted">Includes Rudyard Kipling‚Äôs <em>If‚Äî</em> (the ‚Äúyou‚Äôll be a Man, my son!‚Äù poem) and other short classics you can expand gradually.</div>
          </div>
        </div>

        <!-- Panels -->
        <div id="poemWrite" class="card" hidden>
          <div class="split" style="grid-template-columns:1fr">
            <label>
              <div class="muted" style="margin-bottom:6px">Title</div>
              <input id="poemTitleInput" class="input" placeholder="Untitled poem" />
            </label>
            <label>
              <div class="muted" style="margin-bottom:6px">Your poem</div>
              <textarea id="poemBodyInput" class="textarea" placeholder="Write from the heart..."></textarea>
            </label>
            <div class="actions" style="justify-content:flex-end">
              <button id="poemSaveBtn" class="btn" type="button">Save</button>
              <button id="poemShareBtn" class="btn primary" type="button">Share</button>
            </div>
          </div>
        </div>

        <div id="poemRead" class="card" hidden>
          <div class="split" style="grid-template-columns:1fr">
            <div class="list" id="poemList" aria-label="Poem list"></div>
            <div id="poemViewer" class="poem-view" hidden>
              <div class="poem-title" id="pvTitle"></div>
              <div class="muted" id="pvAuthor"></div>
              <div class="poem-text" id="pvText"></div>
              <div class="actions">
                <button id="pvExpand" class="btn" type="button">Expand</button>
                <button id="pvClose" class="btn danger" type="button">Close</button>
              </div>
            </div>
          </div>
        </div>

      </div>

      <div class="bottom">
        <span class="hint" style="margin-right:auto">Your saved poems are kept locally on this device.</span>
        <button class="btn" id="poemsHelp" type="button" title="Help">Help</button>
      </div>
    </div>
  </dialog>

<script>
(function(){
  const prefersReduced = window.matchMedia('(prefers-reduced-motion: reduce)').matches;

  /* ---------------- Stars BG ---------------- */
  const canvasBG = document.getElementById('stars');
  const ctxBG = canvasBG.getContext('2d');
  let STAR_COUNT = 160, STARS = [], raf = 0;

  function sizeStarCanvas(){
    const dpr = Math.max(1, Math.min(window.devicePixelRatio || 1, 2));
    const { innerWidth: w, innerHeight: h } = window;
    canvasBG.width = Math.floor(w * dpr);
    canvasBG.height = Math.floor(h * dpr);
    canvasBG.style.width = w + 'px';
    canvasBG.style.height = h + 'px';
    ctxBG.setTransform(dpr, 0, 0, dpr, 0, 0);
  }
  function makeStars(){
    STARS = Array.from({length: STAR_COUNT}).map(()=>({
      x: Math.random()*innerWidth,
      y: Math.random()*innerHeight,
      z: Math.random()*1.5 + .3,
      dx: (Math.random()-.5)*0.15,
      dy: (Math.random()-.5)*0.15
    }));
  }
  function renderStaticStars(){
    ctxBG.clearRect(0,0,canvasBG.width,canvasBG.height);
    STARS.forEach(s=>{
      ctxBG.fillStyle = `rgba(255,255,255,${0.25*s.z})`;
      ctxBG.fillRect(s.x, s.y, 1.2*s.z, 1.2*s.z);
    });
  }
  function tickStars(){
    ctxBG.clearRect(0,0,canvasBG.width,canvasBG.height);
    STARS.forEach(s=>{
      s.x += s.dx*s.z; s.y += s.dy*s.z;
      if(s.x<0) s.x+= innerWidth; if(s.x>innerWidth) s.x-= innerWidth;
      if(s.y<0) s.y+= innerHeight; if(s.y>innerHeight) s.y-= innerHeight;
      ctxBG.fillStyle = `rgba(255,255,255,${0.25*s.z})`;
      ctxBG.fillRect(s.x, s.y, 1.2*s.z, 1.2*s.z);
    });
    raf = requestAnimationFrame(tickStars);
  }
  function startStars(){
    sizeStarCanvas(); makeStars();
    if(prefersReduced){ cancelAnimationFrame(raf); renderStaticStars(); }
    else { cancelAnimationFrame(raf); raf = requestAnimationFrame(tickStars); }
  }
  addEventListener('resize', startStars, { passive:true });
  startStars();

  /* ---------------- XP UI ---------------- */
  const MAX_LEVEL = 100;
  function xpForNext(level){
    if(level>=MAX_LEVEL) return Infinity;
    const base=200, growth=1.12;
    return Math.round(base*Math.pow(growth,level));
  }
  function loadXP(){
    try{ return JSON.parse(localStorage.getItem("xp_v1")) || {level:0, xp:0}; }
    catch { return {level:0, xp:0}; }
  }
  function updateXPUI(){
    const xp = loadXP();
    const need = xpForNext(xp.level);
    const badge = document.getElementById('xpBadge');
    const fill = document.getElementById('xpFill');
    const meta = document.getElementById('xpMeta');

    badge.textContent = `Level ${xp.level}`;
    const pct = xp.level>=MAX_LEVEL ? 100 : Math.max(0, Math.min(100, Math.round(100*(xp.xp/need))));
    fill.style.width = pct + "%";
    meta.textContent = xp.level>=MAX_LEVEL ? `MAX ‚Ä¢ Level ${MAX_LEVEL}` : `${xp.xp} / ${need} XP`;
    fill.setAttribute('aria-valuenow', String(pct));
  }
  updateXPUI();
  document.addEventListener('visibilitychange', () => { if(!document.hidden) updateXPUI(); });
  window.addEventListener('storage', (e)=>{ if(e.key==="xp_v1") updateXPUI(); });

  /* ---------------- Drawing Studio ---------------- */
  const studio = document.getElementById('studio');
  const openStudio = document.getElementById('openStudio');
  const closeStudio = document.getElementById('closeStudio');

  const draw = document.getElementById('draw');
  const host = document.getElementById('canvasHost');
  const dctx = draw.getContext('2d');

  let drawing = false;
  let brushColor = '#ffffff';
  let brushSize = 8;
  let mode = 'pen'; // 'pen' | 'eraser'

  const MAX_UNDO = 30;
  const undoStack = [];
  const redoStack = [];

  function sizeDrawCanvas(){
    const rect = draw.getBoundingClientRect();
    const dpr = Math.max(1, Math.min(window.devicePixelRatio || 1, 2));
    const cssW = Math.max(1, Math.floor(rect.width));
    const cssH = Math.max(1, Math.floor(rect.height));
    const needW = Math.floor(cssW * dpr);
    const needH = Math.floor(cssH * dpr);

    if(draw.width !== needW || draw.height !== needH){
      let snapshot = null;
      try { snapshot = dctx.getImageData(0,0,draw.width,draw.height); } catch(e){}
      draw.width = needW; draw.height = needH;

      dctx.setTransform(dpr, 0, 0, dpr, 0, 0);
      dctx.lineCap = dctx.lineJoin = 'round';

      if(snapshot){
        const tmp = document.createElement('canvas');
        tmp.width = snapshot.width; tmp.height = snapshot.height;
        const tctx = tmp.getContext('2d'); tctx.putImageData(snapshot, 0, 0);
        dctx.save(); dctx.setTransform(1,0,0,1,0,0);
        dctx.drawImage(tmp, 0, 0, needW, needH);
        dctx.restore();
      }
    }
  }

  function pushUndo(){
    try{
      if(undoStack.length >= MAX_UNDO) undoStack.shift();
      const img = dctx.getImageData(0,0,draw.width,draw.height);
      undoStack.push(img);
      redoStack.length = 0;
    }catch(e){ /* ignore */ }
  }

  function restore(img){
    if(!img) return;
    draw.width = img.width; draw.height = img.height;
    dctx.setTransform(1,0,0,1,0,0);
    dctx.putImageData(img, 0, 0);
    const dpr = Math.max(1, Math.min(window.devicePixelRatio || 1, 2));
    dctx.setTransform(dpr, 0, 0, dpr, 0, 0);
    dctx.lineCap = dctx.lineJoin = 'round';
  }

  function getPos(evt){
    const rect = draw.getBoundingClientRect();
    if(evt.touches && evt.touches[0]){
      return { x: evt.touches[0].clientX - rect.left, y: evt.touches[0].clientY - rect.top };
    }else{
      return { x: evt.clientX - rect.left, y: evt.clientY - rect.top };
    }
  }

  function startDrawing(p){ drawing = true; dctx.beginPath(); dctx.moveTo(p.x, p.y); }
  function drawTo(p){
    if(!drawing) return;
    dctx.globalCompositeOperation = (mode==='pen') ? 'source-over' : 'destination-out';
    dctx.strokeStyle = (mode==='pen') ? brushColor : 'rgba(0,0,0,1)';
    dctx.lineWidth = brushSize;
    dctx.lineTo(p.x, p.y);
    dctx.stroke();
  }
  function endDrawing(){
    if(!drawing) return; drawing = false; dctx.closePath(); pushUndo(); dctx.globalCompositeOperation = 'source-over';
  }

  function openStudioModal(){
    if(typeof studio.showModal === 'function'){ studio.showModal(); }
    else { studio.setAttribute('open',''); }
    requestAnimationFrame(()=>{
      sizeDrawCanvas();
      if(undoStack.length===0) pushUndo();
    });
  }
  function closeStudioModal(){ if(studio.open) studio.close(); else studio.removeAttribute('open'); }

  openStudio.addEventListener('click', openStudioModal);
  closeStudio.addEventListener('click', closeStudioModal);
  studio.addEventListener('cancel', (e)=>{ e.preventDefault(); closeStudioModal(); });

  const ro = new ResizeObserver(()=> sizeDrawCanvas());
  ro.observe(host);

  draw.addEventListener('mousedown', (e)=> startDrawing(getPos(e)));
  draw.addEventListener('mousemove', (e)=> drawTo(getPos(e)));
  addEventListener('mouseup', endDrawing);

  draw.addEventListener('touchstart', (e)=>{ e.preventDefault(); startDrawing(getPos(e)); }, {passive:false});
  draw.addEventListener('touchmove', (e)=>{ e.preventDefault(); drawTo(getPos(e)); }, {passive:false});
  draw.addEventListener('touchend', (e)=>{ e.preventDefault(); endDrawing(); }, {passive:false});

  const penTool = document.getElementById('penTool');
  const eraserTool = document.getElementById('eraserTool');
  function setMode(m){ mode = m; penTool.setAttribute('aria-pressed', String(m==='pen')); eraserTool.setAttribute('aria-pressed', String(m==='eraser')); }
  penTool.addEventListener('click', ()=>setMode('pen'));
  eraserTool.addEventListener('click', ()=>setMode('eraser'));

  const sizeInput = document.getElementById('size');
  sizeInput.addEventListener('input', ()=>{ brushSize = parseInt(sizeInput.value,10)||8; });

  const colorPicker = document.getElementById('colorPicker');
  colorPicker.addEventListener('input', ()=>{ brushColor = colorPicker.value; setMode('pen'); });
  document.querySelectorAll('.color-swatch').forEach(el=>{
    el.addEventListener('click', ()=>{ const c = el.getAttribute('data-color'); brushColor = c; colorPicker.value = c; setMode('pen'); });
  });

  const undoBtn = document.getElementById('undoBtn');
  const redoBtn = document.getElementById('redoBtn');
  undoBtn.addEventListener('click', ()=>{
    if(undoStack.length > 1){
      const current = undoStack.pop(); redoStack.push(current);
      restore(undoStack[undoStack.length-1]);
    }
  });
  redoBtn.addEventListener('click', ()=>{
    if(redoStack.length){ const next = redoStack.pop(); undoStack.push(next); restore(next); }
  });

  const saveBtn = document.getElementById('saveBtn');
  const shareBtn = document.getElementById('shareBtn');
  const deleteBtn = document.getElementById('deleteBtn');

  function download(filename, blob){
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href = url; a.download = filename;
    document.body.appendChild(a); a.click(); a.remove();
    setTimeout(()=>URL.revokeObjectURL(url), 1000);
  }
  function canvasToBlobPromise(type='image/png', quality=1){
    return new Promise(res=> draw.toBlob(b=>res(b), type, quality));
  }

  saveBtn.addEventListener('click', async ()=>{
    const blob = await canvasToBlobPromise('image/png', 1);
    const ts = new Date().toISOString().replace(/[:.]/g,'-');
    const filename = `heart-out-${ts}.png`;
    try{ const preview = draw.toDataURL('image/png', 0.8); localStorage.setItem('heart_last_v1', preview); }catch(e){}
    download(filename, blob);
  });
  shareBtn.addEventListener('click', async ()=>{
    const blob = await canvasToBlobPromise('image/png', 0.95);
    const file = new File([blob], 'heart-out.png', {type:'image/png', lastModified: Date.now()});
    if(navigator.canShare && navigator.canShare({ files:[file] })){
      try{ await navigator.share({ files:[file], title:'My heart on canvas', text:'Shared from Heart page' }); }catch(e){}
    }else{ download('heart-out.png', blob); }
  });
  deleteBtn.addEventListener('click', ()=>{
    const ok = confirm('Delete your current drawing? This cannot be undone.'); if(!ok) return;
    dctx.setTransform(1,0,0,1,0,0); dctx.clearRect(0,0,draw.width,draw.height);
    const dpr = Math.max(1, Math.min(window.devicePixelRatio || 1, 2));
    dctx.setTransform(dpr, 0, 0, dpr, 0, 0); dctx.lineCap = dctx.lineJoin = 'round'; pushUndo();
  });

  /* ---------------- Poems Hub ---------------- */
  const poemsDlg = document.getElementById('poems');
  const openPoems = document.getElementById('openPoems');
  const closePoems = document.getElementById('closePoems');

  const poemWriteTab = document.getElementById('poemWriteTab');
  const poemReadTab  = document.getElementById('poemReadTab');
  const poemWrite = document.getElementById('poemWrite');
  const poemRead  = document.getElementById('poemRead');

  const poemTitleInput = document.getElementById('poemTitleInput');
  const poemBodyInput  = document.getElementById('poemBodyInput');
  const poemSaveBtn = document.getElementById('poemSaveBtn');
  const poemShareBtn = document.getElementById('poemShareBtn');

  const poemList = document.getElementById('poemList');
  const poemViewer = document.getElementById('poemViewer');
  const pvTitle = document.getElementById('pvTitle');
  const pvAuthor = document.getElementById('pvAuthor');
  const pvText = document.getElementById('pvText');
  const pvExpand = document.getElementById('pvExpand');
  const pvClose = document.getElementById('pvClose');

  const poemsHelp = document.getElementById('poemsHelp');

  function showWrite(){ poemWrite.hidden=false; poemRead.hidden=true; }
  function showRead(){ poemWrite.hidden=true; poemRead.hidden=false; poemViewer.hidden=true; }
  poemWriteTab.addEventListener('click', showWrite);
  poemReadTab.addEventListener('click', showRead);

  function openPoemsModal(){
    if(typeof poemsDlg.showModal === 'function'){ poemsDlg.showModal(); }
    else { poemsDlg.setAttribute('open',''); }
    showRead(); // default to Read list
  }
  function closePoemsModal(){ if(poemsDlg.open) poemsDlg.close(); else poemsDlg.removeAttribute('open'); }
  openPoems.addEventListener('click', openPoemsModal);
  closePoems.addEventListener('click', closePoemsModal);
  poemsDlg.addEventListener('cancel', (e)=>{ e.preventDefault(); closePoemsModal(); });

  // Public-domain poems (short/trimmed where helpful)
  const PD_POEMS = [
    {
      id:'if-kipling',
      title:'If‚Äî',
      author:'Rudyard Kipling (1910)',
      lines: [
        'If you can keep your head when all about you',
        '  Are losing theirs and blaming it on you,',
        'If you can trust yourself when all men doubt you,',
        '  But make allowance for their doubting too;',
        'If you can wait and not be tired by waiting,',
        '  Or being lied about, don‚Äôt deal in lies,',
        'Or being hated, don‚Äôt give way to hating,',
        '  And yet don‚Äôt look too good, nor talk too wise:',
        '',
        'If you can dream‚Äîand not make dreams your master;',
        'If you can think‚Äîand not make thoughts your aim;',
        'If you can meet with Triumph and Disaster',
        '  And treat those two impostors just the same;',
        'If you can bear to hear the truth you‚Äôve spoken',
        '  Twisted by knaves to make a trap for fools,',
        'Or watch the things you gave your life to, broken,',
        '  And stoop and build ‚Äôem up with worn-out tools:',
        '',
        'If you can talk with crowds and keep your virtue,',
        '  Or walk with Kings‚Äînor lose the common touch,',
        'If neither foes nor loving friends can hurt you,',
        '  If all men count with you, but none too much;',
        'If you can fill the unforgiving minute',
        '  With sixty seconds‚Äô worth of distance run,',
        'Yours is the Earth and everything that‚Äôs in it,',
        '  And‚Äîwhich is more‚Äîyou‚Äôll be a Man, my son!'
      ]
    },
    {
      id:'hope-dickinson',
      title:'‚ÄúHope‚Äù is the thing with feathers',
      author:'Emily Dickinson (c. 1861)',
      lines:[
        '‚ÄúHope‚Äù is the thing with feathers ‚Äî',
        'That perches in the soul ‚Äî',
        'And sings the tune without the words ‚Äî',
        'And never stops ‚Äî at all ‚Äî',
        '',
        'And sweetest ‚Äî in the Gale ‚Äî is heard ‚Äî',
        'And sore must be the storm ‚Äî',
        'That could abash the little Bird',
        'That kept so many warm ‚Äî'
      ]
    },
    {
      id:'road-not-taken-frost',
      title:'The Road Not Taken',
      author:'Robert Frost (1916)',
      lines:[
        'Two roads diverged in a yellow wood,',
        'And sorry I could not travel both',
        'And be one traveler, long I stood',
        'And looked down one as far as I could',
        'To where it bent in the undergrowth;'
      ]
    },
    {
      id:'ozymandias-shelley',
      title:'Ozymandias',
      author:'Percy Bysshe Shelley (1818)',
      lines:[
        'I met a traveller from an antique land,',
        'Who said‚Äî‚ÄúTwo vast and trunkless legs of stone',
        'Stand in the desert. . . . Near them, on the sand,',
        'Half sunk a shattered visage lies‚Ä¶‚Äù'
      ]
    },
    {
      id:'a-red-red-rose-burns',
      title:'A Red, Red Rose',
      author:'Robert Burns (1794)',
      lines:[
        'O my Luve is like a red, red rose',
        '  That‚Äôs newly sprung in June;',
        'O my Luve is like the melody',
        '  That‚Äôs sweetly played in tune.'
      ]
    }
  ];

  // Build list
  function renderPoemList(){
    poemList.innerHTML = '';
    PD_POEMS.forEach(p=>{
      const item = document.createElement('div');
      item.className = 'list-item';
      const left = document.createElement('div');
      left.innerHTML = `<div style="font-weight:800">${p.title}</div><div class="muted">${p.author}</div>`;
      const right = document.createElement('div');
      right.innerHTML = '‚ñ∂Ô∏è';
      item.appendChild(left); item.appendChild(right);
      item.addEventListener('click', ()=> openPoem(p));
      poemList.appendChild(item);
    });
  }
  renderPoemList();

  // Viewer progressive expansion
  let currentPoem = null;
  let revealed = 0;
  const STEP = 4; // reveal 4 lines per click

  function openPoem(p){
    currentPoem = p;
    revealed = 0;
    pvTitle.textContent = p.title;
    pvAuthor.textContent = p.author;
    pvText.textContent = '';
    poemViewer.hidden = false;
    revealMore();
  }
  function revealMore(){
    if(!currentPoem) return;
    const next = Math.min(currentPoem.lines.length, revealed + STEP);
    const slice = currentPoem.lines.slice(0, next).join('\n');
    pvText.textContent = slice;
    revealed = next;
    // Hide Expand when done
    pvExpand.disabled = revealed >= currentPoem.lines.length;
    pvExpand.textContent = (revealed >= currentPoem.lines.length) ? 'Expanded' : 'Expand';
  }
  pvExpand.addEventListener('click', revealMore);
  pvClose.addEventListener('click', ()=>{ poemViewer.hidden = true; currentPoem = null; revealed = 0; });

  // Write: Save / Share
  function downloadText(filename, text){
    const blob = new Blob([text], {type:'text/plain;charset=utf-8'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href = url; a.download = filename;
    document.body.appendChild(a); a.click(); a.remove();
    setTimeout(()=>URL.revokeObjectURL(url), 1000);
  }
  function saveLocalPoem(title, body){
    try{
      const key = 'poems_user_v1';
      const list = JSON.parse(localStorage.getItem(key) || '[]');
      list.push({ title, body, ts: Date.now() });
      localStorage.setItem(key, JSON.stringify(list));
    }catch(e){}
  }

  poemSaveBtn.addEventListener('click', ()=>{
    const title = (poemTitleInput.value || 'Untitled poem').trim();
    const body = (poemBodyInput.value || '').trim();
    const content = `${title}\n\n${body}\n`;
    const ts = new Date().toISOString().slice(0,19).replace('T',' ');
    downloadText(`${title.replace(/\s+/g,'_')}-${ts}.txt`, content);
    saveLocalPoem(title, body);
  });

  poemShareBtn.addEventListener('click', ()=>{
    const title = (poemTitleInput.value || 'Untitled poem').trim();
    const body = (poemBodyInput.value || '').trim();
    const content = `${title}\n\n${body}\n`;
    const file = new File([content], `${title}.txt`, {type:'text/plain', lastModified: Date.now()});
    if(navigator.canShare && navigator.canShare({ files:[file] })){
      navigator.share({ files:[file], title, text:'A poem from my Heart page' }).catch(()=>{});
    }else{
      downloadText(`${title}.txt`, content);
    }
  });

  poemsHelp.addEventListener('click', ()=>{
    alert('Write a poem to save/share your own words, or read public-domain poems. Click a poem to reveal it gradually with ‚ÄúExpand‚Äù.');
  });

  /* Open/Close */
  // Poems open button already wired above
})();
</script>
</body>
</html>
